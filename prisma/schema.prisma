// Mercy Link 245D Compliance Dashboard Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User roles: ADMIN, DESIGNATED_COORDINATOR, LEAD_STAFF
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  role          String    @default("LEAD_STAFF") // ADMIN, DESIGNATED_COORDINATOR, LEAD_STAFF
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  assignedHouses UserHouse[]
  auditLogs      AuditLog[]
  documents      Document[]
  notifications  Notification[]
}

model UserHouse {
  id      String @id @default(cuid())
  userId  String
  houseId String

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  house House @relation(fields: [houseId], references: [id], onDelete: Cascade)

  @@unique([userId, houseId])
}

model House {
  id            String   @id @default(cuid())
  name          String
  address       String
  county        String
  licenseNumber String?
  capacity      Int      @default(4)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  assignedUsers UserHouse[]
  clients       Client[]
  employees     EmployeeHouse[]
}

model Client {
  id                String    @id @default(cuid())
  firstName         String
  lastName          String
  dob               DateTime
  admissionDate     DateTime
  houseId           String
  photoUrl          String?   // Client profile photo

  // Mental Health Case Manager
  mhCaseManagerName   String?
  mhCaseManagerEmail  String?
  mhCaseManagerPhone  String?

  // CADI/Waiver Case Manager
  cadiCaseManagerName   String?
  cadiCaseManagerEmail  String?
  cadiCaseManagerPhone  String?

  legalRepName      String?
  legalRepPhone     String?
  waiverType        String?   // DD, CADI, BI, etc.
  status            String    @default("ACTIVE") // ACTIVE, DISCHARGED
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Face Sheet - Personal Info
  middleName        String?
  ssn               String?   // Last 4 digits only for security
  gender            String?
  ethnicity         String?
  preferredLanguage String?
  maritalStatus     String?

  // Face Sheet - Insurance
  pmiNumber         String?   // PMI/MA Insurance Number
  insuranceName     String?
  insurancePolicyNumber String?
  insuranceGroupNumber  String?
  insurancePhone    String?

  // Face Sheet - Emergency Contacts
  emergencyContact1Name   String?
  emergencyContact1Phone  String?
  emergencyContact1Relationship String?
  emergencyContact2Name   String?
  emergencyContact2Phone  String?
  emergencyContact2Relationship String?

  // Face Sheet - Medical Providers
  pharmacyName      String?
  pharmacyPhone     String?
  pharmacyAddress   String?
  primaryCareName   String?
  primaryCarePhone  String?
  primaryCareAddress String?
  psychiatristName  String?
  psychiatristPhone String?
  psychiatristAddress String?
  dentalName        String?
  dentalPhone       String?
  dentalAddress     String?
  visionName        String?
  visionPhone       String?
  visionAddress     String?

  // Face Sheet - Additional Info
  allergies         String?
  dietaryRestrictions String?
  diagnoses         String?
  medications       String?

  house              House            @relation(fields: [houseId], references: [id])
  complianceItems    ComplianceItem[]
  documents          Document[]
  admissionDischarges AdmissionDischarge[]
}

model Employee {
  id              String   @id @default(cuid())
  firstName       String
  lastName        String
  email           String?
  phone           String?
  hireDate        DateTime
  position        String   // DSP, LEAD_DSP, DC, DM
  experienceYears Int      @default(0)
  status          String   @default("ACTIVE") // ACTIVE, INACTIVE, TERMINATED
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  assignedHouses  EmployeeHouse[]
  complianceItems ComplianceItem[]
  documents       Document[]
}

model EmployeeHouse {
  id         String @id @default(cuid())
  employeeId String
  houseId    String

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  house    House    @relation(fields: [houseId], references: [id], onDelete: Cascade)

  @@unique([employeeId, houseId])
}

// Tracks all compliance deadlines for both clients and employees
model ComplianceItem {
  id            String    @id @default(cuid())
  entityType    String    // CLIENT, EMPLOYEE
  itemType      String    // See compliance item types below
  itemName      String    // Human-readable name
  dueDate       DateTime
  completedDate DateTime?
  status        String    @default("PENDING") // PENDING, COMPLETED, OVERDUE
  notes         String?
  statuteRef    String?   // Reference to 245D statute
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  clientId   String?
  employeeId String?

  client    Client?    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  employee  Employee?  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  documents Document[]
}

// Client compliance item types:
// ABUSE_PREVENTION_PLAN, PRELIMINARY_CSSP, FUNCTIONAL_ASSESSMENT,
// PLANNING_MEETING_45_DAY, SERVICE_PLAN_CSSP, CSSP_SIGNATURES,
// PROGRESS_REVIEW, ANNUAL_PLANNING_MEETING, SERVICE_RECIPIENT_RIGHTS,
// MEDICATION_ADMIN_RECORD

// Employee compliance item types:
// BACKGROUND_STUDY, MALTREATMENT_TRAINING, ORIENTATION_TRAINING,
// ANNUAL_TRAINING, MEDICATION_ADMIN_TRAINING, PERSON_SPECIFIC_TRAINING,
// FIRST_AID_CPR, TB_TEST, DRIVERS_LICENSE_CHECK

model Document {
  id               String   @id @default(cuid())
  fileName         String
  filePath         String
  fileType         String
  fileSize         Int
  uploadedAt       DateTime @default(now())

  uploadedById     String
  complianceItemId String?
  clientId         String?
  employeeId       String?

  uploadedBy     User            @relation(fields: [uploadedById], references: [id])
  complianceItem ComplianceItem? @relation(fields: [complianceItemId], references: [id], onDelete: SetNull)
  client         Client?         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  employee       Employee?       @relation(fields: [employeeId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String   // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, UPLOAD, STATUS_CHANGE
  entityType String   // USER, HOUSE, CLIENT, EMPLOYEE, COMPLIANCE_ITEM, DOCUMENT
  entityId   String
  details    String   // JSON string with before/after values
  ipAddress  String?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String   // DEADLINE_WARNING, OVERDUE, SYSTEM
  isRead    Boolean  @default(false)
  link      String?  // Link to relevant page
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Admission/Discharge Register for tracking client movements
model AdmissionDischarge {
  id            String   @id @default(cuid())
  clientId      String
  type          String   // ADMISSION, DISCHARGE, TRANSFER_IN, TRANSFER_OUT
  date          DateTime
  fromLocation  String?  // For transfers - where they came from
  toLocation    String?  // For transfers/discharges - where they went
  reason        String?  // Reason for discharge/transfer
  notes         String?
  dischargeType String?  // PLANNED, UNPLANNED, EMERGENCY, DEATH, etc.
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

// Quality Assurance Checklist for periodic reviews
model QAChecklist {
  id              String    @id @default(cuid())
  houseId         String?
  clientId        String?
  checklistType   String    // MONTHLY_HOUSE, QUARTERLY_CLIENT, ANNUAL_REVIEW, INCIDENT_FOLLOWUP
  reviewDate      DateTime
  reviewedBy      String    // User ID who performed the review
  status          String    @default("IN_PROGRESS") // IN_PROGRESS, COMPLETED, NEEDS_ATTENTION
  items           String    // JSON string of checklist items with yes/no/na and notes
  overallNotes    String?
  followUpRequired Boolean  @default(false)
  followUpDate    DateTime?
  followUpNotes   String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}
