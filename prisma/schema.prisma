// Mercy Link 245D Compliance Dashboard Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User roles: ADMIN, DESIGNATED_COORDINATOR, LEAD_STAFF
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  role          String    @default("LEAD_STAFF") // ADMIN, DESIGNATED_COORDINATOR, LEAD_STAFF
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  assignedHouses UserHouse[]
  auditLogs      AuditLog[]
  documents      Document[]
  notifications  Notification[]
}

model UserHouse {
  id      String @id @default(cuid())
  userId  String
  houseId String

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  house House @relation(fields: [houseId], references: [id], onDelete: Cascade)

  @@unique([userId, houseId])
}

model House {
  id            String   @id @default(cuid())
  name          String
  address       String
  county        String
  licenseNumber String?
  capacity      Int      @default(4)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  assignedUsers UserHouse[]
  clients       Client[]
  employees     EmployeeHouse[]
}

model Client {
  id                String    @id @default(cuid())
  firstName         String
  lastName          String
  dob               DateTime
  admissionDate     DateTime
  houseId           String
  caseManagerName   String?
  caseManagerEmail  String?
  caseManagerPhone  String?
  legalRepName      String?
  legalRepPhone     String?
  waiverType        String?   // DD, CADI, BI, etc.
  status            String    @default("ACTIVE") // ACTIVE, DISCHARGED
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  house           House            @relation(fields: [houseId], references: [id])
  complianceItems ComplianceItem[]
  documents       Document[]
}

model Employee {
  id              String   @id @default(cuid())
  firstName       String
  lastName        String
  email           String?
  phone           String?
  hireDate        DateTime
  position        String   // DSP, LEAD_DSP, DC, DM
  experienceYears Int      @default(0)
  status          String   @default("ACTIVE") // ACTIVE, INACTIVE, TERMINATED
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  assignedHouses  EmployeeHouse[]
  complianceItems ComplianceItem[]
  documents       Document[]
}

model EmployeeHouse {
  id         String @id @default(cuid())
  employeeId String
  houseId    String

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  house    House    @relation(fields: [houseId], references: [id], onDelete: Cascade)

  @@unique([employeeId, houseId])
}

// Tracks all compliance deadlines for both clients and employees
model ComplianceItem {
  id            String    @id @default(cuid())
  entityType    String    // CLIENT, EMPLOYEE
  itemType      String    // See compliance item types below
  itemName      String    // Human-readable name
  dueDate       DateTime
  completedDate DateTime?
  status        String    @default("PENDING") // PENDING, COMPLETED, OVERDUE
  notes         String?
  statuteRef    String?   // Reference to 245D statute
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  clientId   String?
  employeeId String?

  client    Client?    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  employee  Employee?  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  documents Document[]
}

// Client compliance item types:
// ABUSE_PREVENTION_PLAN, PRELIMINARY_CSSP, FUNCTIONAL_ASSESSMENT,
// PLANNING_MEETING_45_DAY, SERVICE_PLAN_CSSP, CSSP_SIGNATURES,
// PROGRESS_REVIEW, ANNUAL_PLANNING_MEETING, SERVICE_RECIPIENT_RIGHTS,
// MEDICATION_ADMIN_RECORD

// Employee compliance item types:
// BACKGROUND_STUDY, MALTREATMENT_TRAINING, ORIENTATION_TRAINING,
// ANNUAL_TRAINING, MEDICATION_ADMIN_TRAINING, PERSON_SPECIFIC_TRAINING,
// FIRST_AID_CPR, TB_TEST, DRIVERS_LICENSE_CHECK

model Document {
  id               String   @id @default(cuid())
  fileName         String
  filePath         String
  fileType         String
  fileSize         Int
  uploadedAt       DateTime @default(now())

  uploadedById     String
  complianceItemId String?
  clientId         String?
  employeeId       String?

  uploadedBy     User            @relation(fields: [uploadedById], references: [id])
  complianceItem ComplianceItem? @relation(fields: [complianceItemId], references: [id], onDelete: SetNull)
  client         Client?         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  employee       Employee?       @relation(fields: [employeeId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String   // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, UPLOAD, STATUS_CHANGE
  entityType String   // USER, HOUSE, CLIENT, EMPLOYEE, COMPLIANCE_ITEM, DOCUMENT
  entityId   String
  details    String   // JSON string with before/after values
  ipAddress  String?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String   // DEADLINE_WARNING, OVERDUE, SYSTEM
  isRead    Boolean  @default(false)
  link      String?  // Link to relevant page
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
